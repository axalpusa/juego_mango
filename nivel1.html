<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Animación sprites</title>
    <style>
        body {
            width: 1000px;
            margin: 0 auto;
            text-align: center;
        }

        canvas {
            background-color: green;
            border: solid yellow 3px;
        }
    </style>
    <script>

        var canvas, ctx, tecla, teclaNumero, objeto1, posicion, objeto;
        var objetos_array = ["Stone.png", "Stone_1.png", "Stone_2.png", "Stone_3.png"];
        var posicionDerecha = 540;
        var posicionIzquierda = 470;
        var posicionCarro = 510;
        var vidas = 5;
        var cantidadObjeto = 0;
        var arregloColisiones = [];
        var youWin = false;
        var contadorTotal = 0;
        var gameOver = false;
        var objetos_pocision_array = [posicionDerecha, posicionIzquierda];
        window.onload = function () {
            canvas = document.getElementById("canvas");
            if (canvas && canvas.getContext) {
                ctx = canvas.getContext("2d");
                if (ctx) {

                    var accion = [
                        {a: "Run", n: 1},
                        {a: "Left", n: 1},
                        {a: "Down", n: 1},
                        {a: "Rigth", n: 1},
                        {a: "Jump", n: 1},
                        {a: "Dead", n: 1},
                        {a: "Choque", n: 1}
                    ];
                    // Cuadro inicial
                    let cuadro = 1;
                    teclaNumero = 0;
                    escala = .5;
                    carro = [];
                    for (var i = 0; i < accion.length; i++) {
                        for (var j = 0; j < accion[i].n; j++) {
                            carro.push({
                                a: accion[i].a,
                                c: j + 1,
                                s: null
                            });
                        }
                    }
                    document.onkeypress = function (e) {
                        tecla = e.key.toLowerCase();
                        if (tecla === 'w') {
                            teclaNumero = Number(0);// Acción para tecla W
                        } else if (tecla === 'a') {
                            teclaNumero = Number(1);// Acción para tecla A
                            posicionCarro = posicionIzquierda;
                        } else if (tecla === 's') {
                            teclaNumero = Number(2);// Acción para tecla S
                            //corre = false;
                        } else if (tecla === 'd') {
                            teclaNumero = Number(3);// Acción para tecla D
                            posicionCarro = posicionDerecha;
                        } else if (e.code === 'Space') { // Detectar la barra espaciadora
                            teclaNumero = Number(4);
                        } else {
                            teclaNumero = Number(0);
                        }
                    }
                    var fondo = new Image();
                    fondo.src = "imagenes/carretera.png";
                    fondo.onload = function () {
                        var inicioY = fondo.height;
                        var altura = 0;
                        var dy = 2;
                        //sprite
                        let numeroDeFrames = accion[teclaNumero].n;
                        let movimiento = accion[teclaNumero].a;
                        let cuadro = 1;
                        let anchoCarro, altoCarro;
                        objetoy = inicioY;
                        generaObjeto();
                        objeto = true;
                        setInterval(function () {
                            dy = dy + 1;
                            contadorTotal++;
                        }, 2800);
                        setInterval(function () {
                            if (contadorTotal === 15) {
                                youWin = true;
                            }
                            //dibuja fondo
                            inicioY -= dy;
                            altura += dy;
                            ctx.drawImage(fondo, 0, inicioY, fondo.width, altura, 0, 0, fondo.width, altura);
                            ctx.drawImage(fondo, 0, 0, fondo.width, fondo.height - altura, 0, fondo.height - inicioY, fondo.width, fondo.height - altura);
                            //Reiniciamos el fondo
                            if (altura >= fondo.height) {
                                inicioY = fondo.height;
                                altura = 0;
                                generaObjeto();
                            }

                            if (objeto) {
                                ctx.drawImage(objeto1,
                                    0, 0, fondo.width, fondo.height - altura,
                                    posicion, fondo.height - inicioY, fondo.width, fondo.height - altura);
                            }
                            movimiento = accion[teclaNumero].a;

                            if (posicionCarro == posicion && (altura > 420 && altura < 480)) {
                                arregloColisiones.push(cantidadObjeto);
                                movimiento = accion[6].a;
                                console.log("colision")
                                const arraySinDuplicados = [...new Set(arregloColisiones)];
                                if (arraySinDuplicados.length == vidas) {
                                    movimiento = accion[5].a;
                                }
                            }
                            //lee datos
                            numeroDeFrames = accion[teclaNumero].n;
                            //Dibuja carro
                            index = existe(movimiento, cuadro);
                            if (carro[index].s == null) {
                                var sprite = new Image();
                                sprite.src = "redhatfiles/png/" + movimiento + " (" + cuadro + ").png";

                                sprite.onload = function () {
                                    ctx.drawImage(sprite, posicionCarro, 450,
                                        sprite.width * escala, sprite.height * escala);
                                    if (movimiento === "Dead") {
                                        gameOver = true;
                                    }
                                    carro[index].s = sprite;
                                    anchoCarro = sprite.width;
                                    altoCarro = sprite.height;
                                }

                            } else {
                                ctx.drawImage(carro[index].s, posicionCarro, 450,
                                    anchoCarro * escala, altoCarro * escala);
                            }

                            // Siguiente cuadro
                            cuadro++;
                            // Número de cuadro
                            if (cuadro > numeroDeFrames) {
                                cuadro = 1;
                            }
                            if (gameOver) {
                                alert("GAME OVER")
                            }
                            if (youWin) {
                                alert("WINNER")
                            }
                        }, 1000 / 60);
                    }
                }
            }
        }

        function generaObjeto() {
            objeto = true;
            objetox = canvas.width;
            objeto1 = new Image();
            let i = Math.floor(Math.random() * objetos_array.length)
            objeto1.src = "objetos/" + objetos_array[i];
            let j = Math.floor(Math.random() * objetos_pocision_array.length)
            posicion = objetos_pocision_array[j];
            cantidadObjeto++;
        }

        function existe(accion, cuadro) {
            for (var i = 0; i < carro.length; i++) {
                if (carro[i].a == accion &&
                    carro[i].c == cuadro) {
                    return i;
                }
            }
            return -1;
        }

        const score = () => {
            game.ctx.fillStyle = "red";
            game.ctx.font = "bold 20px Courier";
            game.ctx.fillText("PUNTOS: " + game.puntos, 10, 20);
            game.ctx.restore();

            game.ctx.fillStyle = "red";
            game.ctx.font = "bold 20px Courier";
            game.ctx.fillText("VIDAS: " + (vidas - arraySinDuplicados), 400, 20);
            game.ctx.restore();

        }
    </script>
</head>
<body>
<canvas id="canvas" width="1000px" height="650px">
    Tu navegador no soporta CANVAS
</canvas>
</body>
</html>
